<route id="direct_createArticle" routeConfigurationId="verify-login,generic-error,return-201" xmlns="http://camel.apache.org/schema/spring">
  <from uri="direct:createArticle"/>

  <marshal><json /></marshal>
  <unmarshal><json unmarshalType="java.util.Map" /></unmarshal>

  <setProperty name="__tags">
    <simple>${body['article']['tagList']}</simple>
  </setProperty>

  <marshal><json /></marshal>
  <to uri="jslt:classpath:jslt/create-article-req2db.jslt" />

  <unmarshal><json library="Jackson" unmarshalType="com.github.jacekszymanski.realcamel.entity.Article" /></unmarshal>

  <script>
    <groovy>
      request.body.'author' = exchange.properties.'loggedInUser'
      exchange.properties.'__tags'.each { request.body.addTag(it) }
    </groovy>
  </script>

  <to uri="jpa:com.github.jacekszymanski.realcamel.entity.Article?usePersist=true" />

  <setProperty name="articleIds">
    <groovy>[request.body.id]</groovy>
  </setProperty>

  <to uri="sql:classpath:sql/favorites-for-articles.sql?outputHeader=__favorites&amp;outputType=SelectOne" />

  <marshal><json /></marshal>
  <to uri="jslt:classpath:jslt/create-article-resp.jslt" />
  <removeHeader name="__favorites" />

  <log message="Article created: ${body}" />

  <unmarshal><json
    library="Jackson"
    unmarshalType="com.github.jacekszymanski.realcamel.model.CreateArticle201Response"
    disableFeatures="FAIL_ON_UNKNOWN_PROPERTIES"
  /></unmarshal>

</route>
