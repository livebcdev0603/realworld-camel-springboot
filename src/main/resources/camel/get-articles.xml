<route id="direct_getArticles"
  routeConfigurationId="maybe-verify-login,generic-error"
  xmlns="http://camel.apache.org/schema/spring">

  <from uri="direct:getArticles" />

  <setProperty name="__jpa_query">
    <groovy>resource:classpath:scripts/article-feed-query.groovy</groovy>
  </setProperty>

  <log message="Querying for articles: ${exchangeProperty.__jpa_query} with params ${headers.CamelJpaParameters}" />

  <toD uri="xjpa:com.github.jacekszymanski.realcamel.entity.Article?query=select a ${exchangeProperty.__jpa_query}" />

  <log message="Found ${body.size} articles" />

  <choice>
    <when><simple><![CDATA[
      ${body.size} == ${header.CamelXJpaMaximumResults}
    ]]></simple>
      <removeHeaders pattern="CamelXJpa*" />

      <toD uri="xjpa:com.github.jacekszymanski.realcamel.entity.Article?query=select count(a) ${exchangeProperty.__jpa_query}
        &amp;outputType=SelectOne&amp;outputTarget=%__articlesCount" />
    </when>
    <otherwise>
      <setProperty name="__articlesCount">
        <groovy>request.body.size() + request.headers.CamelXJpaFirstResult</groovy>
      </setProperty>
    </otherwise>
  </choice>

  <to uri="direct:returnArticles" />

</route>
