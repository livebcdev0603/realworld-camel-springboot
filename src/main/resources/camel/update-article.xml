<route id="direct_updateArticle"
  routeConfigurationId="verify-login,generic-error"
  xmlns="http://camel.apache.org/schema/spring">

  <from uri="direct:updateArticle" />

  <marshal><json /></marshal>
  <unmarshal><json unmarshalType="java.util.Map" /></unmarshal>

  <setProperty name="updateArticle"><simple>${body.article}</simple></setProperty>

  <to uri="direct:findArticle" />

  <!-- TODO: refactor with deleteArticle -->
  <filter>
    <simple>${body.author.id} != ${exchangeProperty.loggedInUser.id}</simple>

    <throwException message="You are not the author of this article"
                    exceptionType="com.github.jacekszymanski.realcamel.RouteException" />
  </filter>

  <script><groovy><![CDATA[
    exchange.properties.updateArticle.each {
      if (it.value != null) { request.body."${it.key}" = it.value }
    }
  ]]></groovy></script>

  <to uri="jpa:com.github.jacekszymanski.realcamel.model.Article" />

  <to uri="direct:returnArticle" />

</route>
