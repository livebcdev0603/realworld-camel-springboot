<routes xmlns="http://camel.apache.org/schema/spring">
  <route id="direct_login" routeConfigurationId="generic-error">
    <from uri="direct:login" />

    <log message="received ${body}" loggingLevel="DEBUG" />

    <marshal><json library="Jackson" /></marshal>
    <unmarshal><json library="Jackson" unmarshalType="java.util.Map" /></unmarshal>

    <setProperty name="user">
      <simple>${body['user']}</simple>
    </setProperty>

    <!-- NOTE I don't use xjpa/SelectOne here because it would be bad security practice to reveal
         whether the entered email address exists in the database or not.
      -->
    <to uri="jpa:com.github.jacekszymanski.realcamel.entity.User?namedQuery=selectByEmail&amp;parameters.email=${exchangeProperty.user['email']}" />

    <log message="selected ${body} size ${body.size}" loggingLevel="DEBUG" />

    <filter>
      <simple><![CDATA[
        ${body.size} == 0 || ${body[0].password} != ${exchangeProperty.user['password']}
      ]]></simple>

      <throwException message="Bad login" exceptionType="com.github.jacekszymanski.realcamel.UnauthorizedException" />

    </filter>

    <setBody>
      <simple>${body[0]}</simple>
    </setBody>

    <to uri="direct:loginUser" />
  </route>
</routes>
