<routes xmlns="http://camel.apache.org/schema/spring">
  <route id="direct_login" routeConfigurationId="generic-error">
    <from uri="direct:login" />

    <log message="received ${body}" logName="com.github.jacekszymanski.realcamel" loggingLevel="DEBUG" />

    <marshal><json library="Jackson" /></marshal>
    <unmarshal><json library="Jackson" unmarshalType="java.util.Map" /></unmarshal>

    <setProperty name="user">
      <simple>${body['user']}</simple>
    </setProperty>
    <to uri="jpa:com.github.jacekszymanski.realcamel.entity.User?namedQuery=selectUser&amp;parameters.email=${exchangeProperty.user['email']}" />

    <log message="selected ${body} size ${body.size}" logName="com.github.jacekszymanski.realcamel" loggingLevel="DEBUG" />

    <filter>
      <simple><![CDATA[
        ${body.size} == 0 || ${body[0].password} != ${exchangeProperty.user['password']}
      ]]></simple>

      <setHeader name="CamelHttpResponseCode">
        <constant>401</constant>
      </setHeader>

      <setBody>
        <constant><![CDATA[
          {"errors": {"body": [ "Bad login" ]}}
        ]]></constant>
      </setBody>

      <unmarshal>
        <json unmarshalType="com.github.jacekszymanski.realcamel.model.GenericErrorModel"/>
      </unmarshal>

      <stop />

    </filter>

    <setBody>
      <simple>${body[0]}</simple>
    </setBody>

    <to uri="direct:loginUser" />
  </route>
</routes>
